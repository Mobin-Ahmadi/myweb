{% extends 'mainview/base.html' %}
{% block title %} جزئیات{% endblock %}

{% block content %}

<div class="text-center mb-3">
    <span class="badge rounded-pill px-3 py-2 " style="color: black;background-color: rgb(255, 255, 255);font-size: 20px;">
       دسته  :  {{ post.category }}
    </span>
</div>
<hr>
    <div class="d-flex justify-content-between">
        <h3 class="card-title" style="direction: rtl;">{{ post.title }}</h3>
        
        <small class="text-muted">{{ post.created_at }}</small>
    </div>
    <br><br>
    <p class="card-text" style="font-size: 18px;direction: rtl;">.:  {{ post.description }}  :.</p>
    
    <br><br>
    <hr>
    {% if post.image %}
        <div class="post-image-wrapper" style="max-width: 500px; margin: 0 auto;">
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid rounded shadow">
        </div>
{% endif %}

    {% if post.attachment %}
        <a href="{{ post.attachment.url }}" target="_blank" class="btn btn-outline-primary">
            دانلود فایل
        </a>
    {% endif %}

{% if user.is_authenticated %}
<hr>
<div class="container my-4" style="max-width: 600px;">
    
    <ul id="commentList" class="list-group mt-4">
        {% for comment in post.approved_comments %}
        <li class="list-group-item d-flex flex-column gap-2" id="comment-{{ comment.id }}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>{{ comment.name.username }}</strong>
                    <span class="text-muted small">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                    <p class="mb-1 comment-content">{{ comment.content }}</p>
                </div>
                {% if comment.name == request.user %}
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-warning edit-btn" data-id="{{ comment.id }}">ویرایش</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ comment.id }}">حذف</button>
                </div>
                {% endif %}
            </div>
            {% if comment.name == request.user %}
            <div class="edit-panel mt-2 d-none" id="edit-panel-{{ comment.id }}">
                <input type="text" class="form-control edit-input" value="{{ comment.content }}">
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-primary btn-sm save-edit" data-id="{{ comment.id }}">ثبت</button>
                    <button class="btn btn-secondary btn-sm cancel-edit" data-id="{{ comment.id }}">لغو</button>
                </div>
            </div>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    <div class="card p-3 shadow-sm">
        <h5 class="mb-3" style="text-align: center;">ارسال کامنت</h5>
        <form id="commentForm" class="d-flex flex-column gap-2">
            <textarea id="commentContent" class="form-control" rows="3" placeholder="کامنت خود را وارد کنید..."></textarea>
            <button type="submit" class="btn align-self-end" id="button_send">ارسال</button>
        </form>
        <div id="commentAlert" class="alert alert-success mt-2 d-none" role="alert">
            کامنت شما با موفقیت ثبت شد!
        </div>
    </div>

</div>
{% endif %}

{% csrf_token %}
<script>
const csrftoken = '{{ csrf_token }}';

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('commentForm');
    const commentList = document.getElementById('commentList');
    const commentAlert = document.getElementById('commentAlert');

    // ---------- ارسال کامنت ----------
    if(form){
        form.addEventListener('submit', async function(e){
            e.preventDefault();
            const content = document.getElementById('commentContent').value.trim();
            if(!content) return alert('کامنت نمی‌تواند خالی باشد.');
            const postId = "{{ post.id }}";

            const response = await fetch(`/api/comments/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ content, post: postId }),
                credentials: 'same-origin'
            });

            const data = await response.json();

            if(response.ok){
                // اضافه کردن کامنت به لیست بدون رفرش
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.id = 'comment-' + data.id;
                li.innerHTML = `
                    <span class="comment-content">${data.content}</span>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${data.id}">ویرایش</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${data.id}">حذف</button>
                    </div>
                    <div class="edit-panel mt-2 d-none" id="edit-panel-${data.id}">
                        <input type="text" class="form-control edit-input" value="${data.content}">
                        <button class="btn btn-primary btn-sm save-edit" data-id="${data.id}">ثبت</button>
                        <button class="btn btn-secondary btn-sm cancel-edit" data-id="${data.id}">لغو</button>
                    </div>
                `;
                commentList.prepend(li);
                document.getElementById('commentContent').value = '';
                commentAlert.classList.remove('d-none');
                setTimeout(() => commentAlert.classList.add('d-none'), 3000);
            } else {
                alert(data.detail || 'خطا در ارسال کامنت!');
            }
        });
    }

    // ---------- مدیریت Edit/Delete با Event Delegation ----------
    commentList.addEventListener('click', function(e){
        const target = e.target;
        const commentId = target.dataset.id;

        // باز کردن پنل ویرایش
        if(target.classList.contains('edit-btn')){
            document.getElementById('edit-panel-' + commentId).classList.remove('d-none');
        }

        // لغو ویرایش
        if(target.classList.contains('cancel-edit')){
            document.getElementById('edit-panel-' + commentId).classList.add('d-none');
        }

        // ثبت ویرایش
        if(target.classList.contains('save-edit')){
            const input = document.querySelector('#edit-panel-' + commentId + ' .edit-input');
            const newContent = input.value;

            fetch(`/api/comments/${commentId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ content: newContent })
            })

            .then(res => {
                if(res.ok){
                    document.querySelector('#comment-' + commentId + ' .comment-content').textContent = newContent;
                    document.getElementById('edit-panel-' + commentId).classList.add('d-none');
                } else {
                    alert('خطا در ویرایش کامنت!');
                }
            });

        }

        // حذف کامنت
        if(target.classList.contains('delete-btn')){
            if(!confirm('آیا مطمئن هستید؟')) return;

            fetch(`/api/comments/${commentId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            })

            .then(res => {
                if(res.ok) document.getElementById('comment-' + commentId).remove();
                else alert('خطا در حذف کامنت!');
            });

        }
    });
});
</script>





{% endblock %}
{% extends 'mainview/base.html' %}
{% block title %}بازیابی رمز{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow-sm" style="max-width: 400px; width: 100%;">
        <div class="card-body">
            <h5 class="card-title text-center mb-4">بازیابی رمز عبور</h5>
            <form method="post" class="text-end">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="email" class="form-label">ایمیل خود را وارد کنید</label>
                    <input type="email" id="email" name="email" class="form-control text-end" required>
                </div>
                <button type="submit" class="btn btn-dark w-100">ارسال لینک بازیابی</button>
            </form>
            <div id="message" class="mt-3 text-center"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('passwordResetForm').addEventListener('submit', function(e){
    e.preventDefault();

    let email = document.getElementById('email').value;
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'password_reset' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `email=${encodeURIComponent(email)}`
    })
    .then(response => {
        if(!response.ok){
            throw new Error('خطا در سرور');
        }
        return response.json();
    })
    .then(data => {
        if(data.status === 'ok'){
            document.getElementById('message').innerHTML = '<span class="text-success">لینک بازیابی رمز به ایمیل شما ارسال شد</span>';
            setTimeout(() => { window.location.href = "{% url 'login' %}"; }, 3000);
        } else {
            document.getElementById('message').innerHTML = `<span class="text-danger">${data.message}</span>`;
        }
    })
    .catch(err => {
        document.getElementById('message').innerHTML = `<span class="text-danger">${err.message}</span>`;
    });
});

</script>
{% endblock %}
